{% extends "base.html" %}

{% block content %}
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8" id="stats">
    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <div class="text-gray-400 text-sm mb-1">Total Pipelines</div>
        <div class="text-3xl font-bold" id="total-pipelines">0</div>
    </div>
    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <div class="text-gray-400 text-sm mb-1">Healthy</div>
        <div class="text-3xl font-bold text-green-400" id="healthy-pipelines">0</div>
    </div>
    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <div class="text-gray-400 text-sm mb-1">Degraded/Down</div>
        <div class="text-3xl font-bold text-red-400" id="unhealthy-pipelines">0</div>
    </div>
    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
        <div class="text-gray-400 text-sm mb-1">Avg Response</div>
        <div class="text-3xl font-bold" id="avg-response">0ms</div>
    </div>
</div>

<div class="mb-6 flex justify-between items-center">
    <h2 class="text-2xl font-bold">Pipelines</h2>
    <button onclick="showAddModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
        + Add Pipeline
    </button>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="pipelines">
</div>

<div id="addModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg p-8 max-w-md w-full border border-gray-700">
        <h3 class="text-xl font-bold mb-4">Add New Pipeline</h3>
        <form id="addPipelineForm" onsubmit="addPipeline(event)">
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Name</label>
                <input type="text" name="name" required class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-white">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Endpoint URL</label>
                <input type="url" name="endpoint_url" required class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-white">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Type</label>
                <select name="pipeline_type" required class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-white">
                    <option value="batch">Batch</option>
                    <option value="streaming">Streaming</option>
                    <option value="realtime">Real-time</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Description (optional)</label>
                <textarea name="description" rows="2" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-white"></textarea>
            </div>
            <div class="flex justify-end gap-2">
                <button type="button" onclick="hideAddModal()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded">
                    Cancel
                </button>
                <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded">
                    Create
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let pipelines = [];
let stats = {};

async function loadDashboard() {
    await Promise.all([loadStats(), loadPipelines()]);
}

async function loadStats() {
    try {
        const res = await fetch('/api/metrics/dashboard');
        stats = await res.json();
        updateStatsUI();
    } catch (err) {
        console.error('Failed to load stats:', err);
    }
}

async function loadPipelines() {
    try {
        const res = await fetch('/api/pipelines/');
        pipelines = await res.json();
        updatePipelinesUI();
    } catch (err) {
        console.error('Failed to load pipelines:', err);
    }
}

function updateStatsUI() {
    document.getElementById('total-pipelines').textContent = stats.total_pipelines || 0;
    document.getElementById('healthy-pipelines').textContent = stats.healthy_pipelines || 0;
    document.getElementById('unhealthy-pipelines').textContent = 
        (stats.degraded_pipelines || 0) + (stats.down_pipelines || 0);
    document.getElementById('avg-response').textContent = 
        `${Math.round(stats.avg_response_time || 0)}ms`;
}

function updatePipelinesUI() {
    const container = document.getElementById('pipelines');
    if (pipelines.length === 0) {
        container.innerHTML = `
            <div class="col-span-3 text-center py-12 text-gray-400">
                No pipelines yet. Click "Add Pipeline" to get started.
            </div>
        `;
        return;
    }
    
    container.innerHTML = pipelines.map(p => `
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700 hover:border-gray-600 cursor-pointer transition"
             onclick="window.location.href='/pipeline/${p.id}'">
            <div class="flex items-start justify-between mb-3">
                <div>
                    <h3 class="text-lg font-semibold">${p.name}</h3>
                    <p class="text-sm text-gray-400">${p.pipeline_type}</p>
                </div>
                <span class="status-${p.current_status} w-3 h-3 rounded-full"></span>
            </div>
            <p class="text-sm text-gray-400 mb-3" style="overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                ${p.description || 'No description'}
            </p>
            <div class="flex justify-between text-xs text-gray-500">
                <span>${p.current_status.toUpperCase()}</span>
                <span>${p.last_check_time ? new Date(p.last_check_time).toLocaleTimeString() : 'Never'}</span>
            </div>
        </div>
    `).join('');
}

function showAddModal() {
    document.getElementById('addModal').classList.remove('hidden');
}

function hideAddModal() {
    document.getElementById('addModal').classList.add('hidden');
    document.getElementById('addPipelineForm').reset();
}

async function addPipeline(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = {
        name: formData.get('name'),
        endpoint_url: formData.get('endpoint_url'),
        pipeline_type: formData.get('pipeline_type'),
        description: formData.get('description') || null
    };
    
    try {
        const res = await fetch('/api/pipelines/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (res.ok) {
            hideAddModal();
            await loadDashboard();
        } else {
            const err = await res.json();
            alert(err.detail || 'Failed to create pipeline');
        }
    } catch (err) {
        console.error('Failed to create pipeline:', err);
        alert('Failed to create pipeline');
    }
}

setInterval(() => {
    loadStats();
    loadPipelines();
}, 5000);

loadDashboard();
</script>
{% endblock %}
